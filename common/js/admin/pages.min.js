$.fn.cyclate_pages=function(e,a,t){$.random_colour=function(){return Math.floor(256*Math.random())+","+Math.floor(156*Math.random())+","+Math.floor(156*Math.random())};var n;storage.isSet("pgrdg_cache.local.info")&&(n=storage.get("pgrdg_cache.local.info")),(void 0===a||null===a||""===a)&&(a=!1),(void 0===t||null===t||""===t)&&(t=""),$.obj_len(e.subpages)>0&&(colour=$.random_colour());var s=$(this),i=$('<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">'),l=$("<a>").attr({href:"javascript:void(0);",onclick:"$.edit_page('"+JSON.stringify(e)+"', '"+JSON.stringify(n)+"');","class":"big_btn","data-content":"",style:function(){return $.obj_len(e.subpages)>0?"box-shadow: 0 0 9px rgb("+colour+") inset;":a?"":"box-shadow: 0 0 9px rgba("+colour+", 0.35) inset;"},title:"Edit this page"}),o=$('<div class="folded">'),c=$("<img>").attr({src:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D"}),p=$('<div class="big_btn_title">'),r=$('<span class="title fittext">').html(e.title+(a?"":"<small>subpage of "+t+"</small>")).fitText(1.2,{minFontSize:"20px",maxFontSize:"40px"}),d=$('<div class="icons_list">'),_=$('<span class="fa fa-'+(e.need_login?"lock":"unlock")+'">'),g=$('<span class="fa fa-'+(e.is_visible?"eye":"eye-slash")+'">'),u=$('<span class="fa fa-'+(e.subpages?"files-o":"file-o")+'">');d.append(_),d.append(g),a||d.append('<span class="fa fa-indent"></span>'),d.append(u),p.append(r),p.append(d),o.append(c),l.append(o),l.append(p),i.append(l),s.append(i),$.obj_len(e.subpages)>0&&$.each(e.subpages,function(a,t){s.cyclate_pages(t,!1,e.title)}),$.ajax({url:"https://www.googleapis.com/pagespeedonline/v1/runPagespeed?url=http://pgrdiversity.bioversityinternational.org/"+e.address+"&screenshot=true",context:this,type:"GET",dataType:"json",success:function(e){e=e.screenshot.data.replace(/_/g,"/").replace(/-/g,"+"),c.attr("src","data:image/jpeg;base64,"+e)}})},$.disable_save_btn=function(){$("#save_btn").hasClass("disabled")||$("#save_btn").addClass("disabled")},$.fn.check_inputs=function(){return $.trim($(this).val()).length>0?!0:!1},$.add_page=function(e){var a=$.parseJSON(e),t=a.info;console.log(a),console.log(t),$("#page_management").hide(),$("#page_management_edit").append('<h1 unselectable="on"><span class="fa fa-gear fa-spin"></span> '+i18n[lang].messages.loading_form+"</h1>").show();var n=$('<div class="row">'),s=$('<div id="page_management_form_container" class="col-xs-offset-1 col-sm-offset-1 col-xs-12 col-sm-8 col-lg-10 well form">'),i=$("<fieldset>"),l=$("<legend>").text("Adding new page"),o=$('<form class="form-horizontal">'),c=$('<textarea id="text_editor" class="form-control">');$btn_div=$('<div class="col-xs-offset-1 col-sm-offset-1 col-xs-12 col-sm-8 col-lg-10">'),$cancel_btn=$('<a href="javascript:void(0);" onclick="$.cancel_page_editing();" class="btn btn-default-white pull-left">').html('<span class="fa fa-angle-left"></span> '+i18n[lang].interface.btns.cancel),$save_btn=$("<a>").attr({id:"save_btn",href:"javascript:void(0);",onclick:"$.save_page_data();","class":"btn btn-default pull-right disabled"}).html(i18n[lang].interface.btns.save+' <span class="fa fa-angle-right"></span>'),$.each(t,function(e,a){var t=$('<div class="form-group">'),n=($("<div>"),$("<label>")),s=$('<div class="col-sm-5 col-xs-12">');if($input=$("<input>"),"_id"!==e&&"obj_name"!=e&&"is_system_page"!=e&&"is_main_page"!=e&&"subpages"!=e){switch(n.attr({"class":"col-sm-1 col-sm-offset-2 control-label col-xs-12","for":"__"+e}).text($.ucfirst($.trim(e.replace("is","").replace(/\_/g," ")))),$input.attr("checkbox"==a.input_type?{type:"checkbox",name:e,id:"__"+e}:{type:"text",name:e,id:"__"+e,"class":"form-control",value:"",placeholder:a.description}),a.required&&(n.append(' <span class="text-danger">*</span>'),$input.attr("required",!0).addClass("required")),e){case"title":$input.css("width","50%");break;case"address":$input.on("blur",function(){var e=$(this).val();$(this).val($.trim(e))}).attr("id","address")}s.append($input),n.attr("title",a.description).tooltip(),t.append(n),t.append(s)}else"checkbox"==a.input_type?$input.attr({type:"checkbox",name:e,id:"__"+e,"class":"hidden"}):($input.attr({type:"hidden",name:e,id:"__"+e,"class":"form-control",value:"",placeholder:a.description}),"disabled"==a.input_type&&$input.attr("disabled",!0)),s.append($input),t.append(s),$input.hasClass("hidden")&&(s.addClass("hidden"),t.addClass("hidden"));o.append(t)}),o.append("<hr />"),o.append('<div class="alert alert-info"><b>Note:</b> For collaborative editing, you can also work on <a href="https://stackedit.io/" target="_blank">StackEdit</a> and paste the Markdown content here</div>'),o.append(c),i.append(l),i.append(o),$btn_div.append($cancel_btn).append($save_btn),s.append(i),n.append(s),n.append($btn_div),$("#page_management_edit").html(n),$("[type='checkbox']:not(.hidden)").bootstrapSwitch({size:"small",labelText:"⋮",onText:"Yes",offText:"No"}),$("#text_editor").markItUp(mySettings),$("button.preview").click(function(){$("#content").scrollTo(900,800)}),$("#__title").blur(function(){$("#__obj_name").val($(this).val()),$("#___id").val($.md5($(this).val()))}),o.find("input[type=text].required").on("keyup blur",function(){$(this).check_inputs()&&c.check_inputs()?$("#save_btn").removeClass("disabled"):$.disable_save_btn(),c.on("keyup blur",function(){$(this).check_inputs()&&o.find("input[type=text].required").check_inputs()?$("#save_btn").removeClass("disabled"):$.disable_save_btn()})})},$.edit_page=function(e,a){var t=$.parseJSON(e),n=$.parseJSON(a),s=""===t.address.replace(/\_/g," ")?"home":t.address.replace(/\_/g," ");$("#page_management").hide(),$("#page_management_edit").append('<h1 unselectable="on"><span class="fa fa-gear fa-spin"></span> '+i18n[lang].messages.loading_form+"</h1>").show(),console.log(t._id);var i=$('<div class="row">'),l=$('<div id="page_management_form_container" class="col-xs-offset-1 col-sm-offset-1 col-xs-12 col-sm-8 col-lg-10 well form">'),o=$("<fieldset>"),c=$("<legend>").text('Editing page "'+t.title+'"'),p=$('<form class="form-horizontal">'),r=$('<textarea id="text_editor" class="form-control">');$btn_div=$('<div class="col-xs-offset-1 col-sm-offset-1 col-xs-12 col-sm-8 col-lg-10">'),$btn_group=$('<div class="btn-group">'),$cancel_btn=$('<a href="javascript:void(0);" onclick="$.cancel_page_editing();" class="btn btn-default-white pull-left">').html('<span class="fa fa-angle-left"></span> '+i18n[lang].interface.btns.cancel),$remove_btn=$('<a href="javascript:void(0);" onclick="$.remove_page(\''+t._id+'\');" class="btn btn-danger">').html(i18n[lang].interface.btns.remove_page+' <span class="fa fa-trash-o"></span>'),$save_btn=$("<a>").attr({id:"save_btn",href:"javascript:void(0);",onclick:"$.save_page_data();","class":"btn btn-default pull-right"}).html(i18n[lang].interface.btns.save+' <span class="fa fa-angle-right"></span>'),$.each(t,function(e,t){$.is_array(t)&&(t=t.join(", "));var s=$('<div class="form-group">'),i=($("<div>"),$("<label>")),l=$('<div class="col-sm-5 col-xs-12">');if($input=$("<input>"),"_id"!==e&&"obj_name"!=e&&"is_system_page"!=e&&"is_main_page"!=e&&"subpages"!=e){switch(i.attr({"class":"col-sm-3 control-label col-xs-12","for":"__"+e}).text($.ucfirst($.trim(e.replace("is","").replace(/\_/g," ")))),"checkbox"==n[e].input_type?($input.attr({type:"checkbox",name:e,id:"__"+e}),t===!0&&$input.attr({checked:"true"})):$input.attr({type:"text",name:e,id:"__"+e,"class":"form-control",value:"string"==$.type(t)?t.replace(/\_/g," "):JSON.stringify(t),placeholder:$.obj_len(a)>0&&void 0!==n[e].description?n[e].description:""}),n[e].required&&(i.append(' <span class="text-danger">*</span>'),$input.attr("required",!0).addClass("required")),e){case"title":$input.css("width","50%");break;case"address":$input.on("blur",function(){var e=$(this).val();$(this).val($.trim(e))}).attr("id","address")}l.append($input),i.attr("title",t.description).tooltip(),s.append(i),s.append(l)}else"checkbox"==n[e].input_type?($input.attr({type:"checkbox",name:e,id:"__"+e,"class":"hidden"}),t===!0&&$input.attr({checked:"true"})):($input.attr({type:"hidden",name:e,id:"__"+e,"class":"form-control",value:"string"==$.type(t)?t.replace(/\_/g," "):JSON.stringify(t),placeholder:$.obj_len(a)>0&&void 0!==n[e].description?n[e].description:""}),"disabled"==t.input_type&&$input.attr("disabled",!0)),l.append($input),s.append(l),$input.hasClass("hidden")&&(l.addClass("hidden"),s.addClass("hidden"));p.append(s)}),$.ajax({url:"common/include/funcs/_ajax/get_all_pages.php",DataType:"json",crossDomain:!0,type:"GET",timeout:1e4,success:function(e){var a=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("title"),queryTokenizer:Bloodhound.tokenizers.whitespace,local:e});a.initialize(),$("#address").typeahead({hint:!0,highlight:!0,minLength:2},{name:"pages",displayKey:"title",source:a.ttAdapter()}).bind("typeahead:selected, typeahead:cursorchanged",function(e,a){$(this).on("blur",function(){$(this).val(a.link.replace(/\_/g," ").replace(/\//g,""))})})}}),$.ajax({url:"common/md/"+s+".md",context:this,type:"GET",dataType:"text",success:function(e){$("#text_editor").text(e)},error:function(){$.ajax({url:"common/tpl/pages/"+s.replace(/\_/," ")+".tpl",type:"HEAD",success:function(){var e=$('<div class="alert alert-warning">').html('<span class="fa fa-exclamation-triangle"></span> '+i18n[lang].messages.content_managed_by_script.replace("{X}",s));e.insertAfter($("#page_management_form_container .alert"))},error:function(){var e=$('<div class="alert alert-danger">').html('<span class="fa fa-times fa-1_5x pull-left"></span> '+i18n[lang].messages.content_not_exists.replace("{X}",s+".md"));e.insertAfter($("#page_management_form_container .alert"))}})}}),p.append("<hr />"),p.append('<div class="alert alert-info"><b>Note:</b> For collaborative editing, you can also work on <a href="https://stackedit.io/" target="_blank">StackEdit</a> and paste the Markdown content here</div>'),p.append(r),o.append(c),o.append(p),$btn_group.append($cancel_btn).append($remove_btn),$btn_div.append($btn_group).append($save_btn),l.append(o),i.append(l),i.append($btn_div),$("#page_management_edit").html(i),$("[type='checkbox']:not(.hidden)").bootstrapSwitch({size:"small",labelText:"⋮",onText:"Yes",offText:"No"}),$("#text_editor").markItUp(mySettings),$("button.preview").click(function(){$("#content").scrollTo(900,800)}),$("#__title").blur(function(){$("#__obj_name").val($(this).val()),$("#___id").val($.md5($(this).val()))}),p.find("input[type=text].required").on("keyup blur",function(){$(this).check_inputs()&&r.check_inputs()?$("#save_btn").removeClass("disabled"):$.disable_save_btn(),r.on("keyup blur",function(){$(this).check_inputs()&&p.find("input[type=text].required").check_inputs()?$("#save_btn").removeClass("disabled"):$.disable_save_btn()})})},$.cancel_page_editing=function(){$("#page_management").fadeIn(300),$("#page_management_edit").fadeOut(300,function(){$("#page_management_edit").html("")})},$.remove_page=function(e){console.warn(e),$.get_all_pages_config(function(a){var t=a.info,n="",s={},i={},l={};s.info=t,$.each(a.pages,function(a,t){t._id!==e?i[a]=t:n=t.obj_name}),s.pages=i,l.data=s,l.title=n,console.log(l),$.require_password(function(){$("#loader").show(),$.ask_cyphered_to_service({storage_group:"pgrdg_user_cache.local.page_data",data:l,dataType:"text",type:"remove_page"},function(e){$("#loader").hide(),"ok"==e?($.log_activity({action:'Removed page "'+n+'"',icon:"fa-file-text-o"}),apprise(i18n[lang].messages.page_deleted.message,{title:i18n[lang].messages.page_deleted.title,icon:"fa-check",titleClass:"text-success"},function(){location.reload()})):apprise(i18n[lang].messages.page_not_deleted.message,{title:i18n[lang].messages.page_not_deleted.title,icon:"fa-times",titleClass:"text-danger"})})})})},$.save_page_data=function(){var e=$.fn.serializeArray;$.fn.extend({serializeArray:function(){var a=e.apply(this),t=$(this).find("input[type=checkbox]").map(function(){return{name:this.name,value:this.checked}}).get(),n=$.map(t,function(e){return e.name}),s=$.grep(a,function(e){return-1==$.inArray(e.name,n)});return $.merge(s,t)}});var a=$("#page_management_form_container form").serializeArray(),t={},n={},s={};$.each(a,function(e,a){t[a.name]=a.value}),t.subpages="",n[t.obj_name]=t,console.info("Page config:"),console.log(n),console.info("Page Markdown content"),console.log($("#text_editor").val()),s.data=n,s.content={title:t.obj_name,content:$("#text_editor").val()},$.require_password(function(){$("#loader").show(),$.ask_cyphered_to_service({storage_group:"pgrdg_user_cache.local.page_data",data:s,dataType:"text",type:"save_page_data"},function(e){$("#loader").hide(),"ok"==e?($.log_activity({action:'Changed page "'+t.obj_name+'"',icon:"fa-file-text-o"}),apprise(i18n[lang].messages.page_saved.message,{title:i18n[lang].messages.page_saved.title,icon:"fa-check",titleClass:"text-success"},function(){location.reload()})):apprise(i18n[lang].messages.page_not_saved.message,{title:i18n[lang].messages.page_not_saved.title,icon:"fa-times",titleClass:"text-danger"})})})},$.init_pages_management=function(){$.get_all_pages_config(function(e){var a=$("<h1>").text("Pages management"),t=$("<button>").attr({"class":"pull-right btn btn-default-white",onclick:"$.add_page('"+JSON.stringify(e)+"');"}).html(i18n[lang].interface.btns.add_page+' <span class="fa fa-plus fa-fw"></span>'),n=$('<div class="row">');$.each(e.pages,function(e,a){void 0===a.is_backend||a.is_backend||n.cyclate_pages(a,!0)}),a.append(t),$("#page_management").html(a).append(n)})};